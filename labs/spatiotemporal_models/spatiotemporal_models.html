<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Garyfallos Konstantinoudis">
<meta name="dcterms.date" content="2023-08-01">

<title>Spatial and Spatio-temporal Modelling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="spatiotemporal_models_files/libs/clipboard/clipboard.min.js"></script>
<script src="spatiotemporal_models_files/libs/quarto-html/quarto.js"></script>
<script src="spatiotemporal_models_files/libs/quarto-html/popper.min.js"></script>
<script src="spatiotemporal_models_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="spatiotemporal_models_files/libs/quarto-html/anchor.min.js"></script>
<link href="spatiotemporal_models_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="spatiotemporal_models_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="spatiotemporal_models_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="spatiotemporal_models_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="spatiotemporal_models_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Spatial and Spatio-temporal Modelling</h1>
<p class="subtitle lead">SHARP Bayesian Modeling for Environmental Health Workshop</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Garyfallos Konstantinoudis </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 1, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell">

</div>
<section id="goal-of-this-computing-lab-session" class="level2">
<h2 class="anchored" data-anchor-id="goal-of-this-computing-lab-session">Goal of this computing lab session</h2>
<p>This goal of this lab is to use <code>R</code> software Statistical Package (www.r-project.org), as well as <code>NIMBLE</code> to carry out a disease mapping study.</p>
</section>
<section id="whats-going-to-happen-in-this-lab-session" class="level2">
<h2 class="anchored" data-anchor-id="whats-going-to-happen-in-this-lab-session">What’s going to happen in this lab session?</h2>
<p>During this lab session, we will:</p>
<ol type="1">
<li>Explore ways of visualizing spatial data;</li>
<li>Define the neighborhood matrix in R;</li>
<li>Fit and interpret the BYM model in NIMBLE; and</li>
<li>Perform spatial ecological regression</li>
</ol>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>We will use the COVID-19 deaths during March-July 2020, in England, at the LTLA geographical level (317 areas), as taken from the published paper:</p>
<p><strong>Konstantinoudis G</strong>, Padellini T, Bennett J, Davies B, Ezzati M, Blangiardo M. <em>Long-term exposure to air-pollution and COVID-19 mortality in England: a hierarchical spatial analysis</em>. medRxiv [Preprint]. 2020 Aug 11:2020.08.10.20171421. doi: 10.1101/2020.08.10.20171421. Update in: Environ Int. 2021 Jan;146:106316. PMID: 32817974; PMCID: PMC7430619.</p>
<p>For that analysis, we included 38,573 COVID-19 deaths up to June 30, 2020 at the Lower Layer Super Output Area level in England (n=32 844 small areas). We retrieved averaged NO2 and PM2.5 concentration during 2014-2018 from the Pollution Climate Mapping. We used Bayesian hierarchical models to quantify the effect of air-pollution while adjusting for a series of confounding and spatial autocorrelation.</p>
<p>We will build simple Bayesian models to try to understand what is happening in the data. Once again we will use <code>NIMBLE</code> as the basis for our Bayesian model writing.</p>
</section>
<section id="visualization-of-spatial-areal-data" class="level2">
<h2 class="anchored" data-anchor-id="visualization-of-spatial-areal-data">Visualization of spatial areal data</h2>
<p>Let’s load in the data</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>data_england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"England"</span>, <span class="st">"COVIDecoregression.shp"</span>))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_england)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 316
Columns: 7
$ LTLA     &lt;chr&gt; "E06000001", "E06000002", "E06000003", "E06000004", "E0600000…
$ deaths   &lt;int&gt; 110, 206, 134, 155, 90, 128, 230, 96, 145, 215, 318, 35, 101,…
$ expectd  &lt;dbl&gt; 78.76883, 103.19093, 130.60260, 156.72359, 97.68445, 92.98230…
$ TtlICUB  &lt;dbl&gt; 0.009952596, 0.039161834, 0.041194283, 0.009735667, 0.0128089…
$ NO2      &lt;dbl&gt; 12.880443, 16.396532, 11.762402, 13.686531, 11.638713, 17.135…
$ IMD      &lt;dbl&gt; 1, 1, 1, 2, 2, 1, 3, 1, 1, 1, 4, 1, 2, 5, 1, 1, 5, 1, 3, 2, 1…
$ geometry &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((447213.9 53..., MULTIPOLYGON (((…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data_england)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     LTLA               deaths          expectd           TtlICUB         
 Length:316         Min.   :   4.0   Min.   :  8.287   Min.   :0.000e+00  
 Class :character   1st Qu.:  77.0   1st Qu.: 99.339   1st Qu.:8.548e-05  
 Mode  :character   Median : 117.5   Median :129.067   Median :8.092e-03  
                    Mean   : 155.6   Mean   :155.630   Mean   :1.399e-02  
                    3rd Qu.: 191.2   3rd Qu.:177.896   3rd Qu.:1.460e-02  
                    Max.   :1226.0   Max.   :903.219   Max.   :1.911e-01  
      NO2             IMD                 geometry  
 Min.   : 4.48   Min.   :1.000   MULTIPOLYGON :316  
 1st Qu.:11.09   1st Qu.:2.000   epsg:27700   :  0  
 Median :13.96   Median :3.000   +proj=tmer...:  0  
 Mean   :15.05   Mean   :2.997                      
 3rd Qu.:17.26   3rd Qu.:4.000                      
 Max.   :46.45   Max.   :5.000                      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(data_england)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sf"         "tbl_df"     "tbl"        "data.frame"</code></pre>
</div>
</div>
<p>The shapefile could be also imported using the function <code>readOGR</code> of the package <code>rgdal</code> (Geospatial Data Abstraction Library), such as <code>data_england &lt;- readOGR(dsn = mypath, layer = "data_england")</code>, where the <code>dsn</code> argument specifies the data source name and <code>mypath</code> is the path where the file is stored. Then to convert <code>sp</code> object to <code>sf</code> object, we can use <code>st_as_sf</code> function, e.g., <code>data_england &lt;- st_as_sf(data_england)</code>. This is not encouraged as the <code>rgdal</code> will be deprecated.</p>
<!-- We can create basic maps of sf objects using the `plot()` function. The default plot of an sf object is a multi-plot of all attributes. -->
<!-- First plot all the attributes -->
<!-- ```{r eval=FALSE} -->
<!-- plot(data_england) -->
<!-- ``` -->
<!-- Next plot only the boundaries -->
<!-- ```{r eval=FALSE} -->
<!-- plot(data_england$geometry)  -->
<!-- ``` -->
<p>We can make nice plots using the package <code>ggplot2</code>, which is very flexible and has lots of options for customising the way we want a plot to look.</p>
<p>First let’s reduce the resolution to get quicker maps. Let’s look at the full map of England and Wales for now, though we will reduce to just London later.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>data_england_simpler <span class="ot">&lt;-</span> <span class="fu">gSimplify</span>(<span class="fu">as</span>(data_england, <span class="st">"Spatial"</span>), <span class="at">tol =</span> <span class="dv">500</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>data_england_simpler <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(data_england_simpler)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>data_england_simpler <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data_england_simpler, data_england <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">geometry =</span> <span class="cn">NULL</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Map of LTLAs in England"</span>) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span> <span class="co"># axis limits and CRS</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Longitude"</span>, <span class="at">y =</span> <span class="st">"Latitude"</span>, <span class="at">fill =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="co"># dark-on-light theme</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>And for nicer maps for the other columns, including COVID-19 deaths, the expected number of deaths, and the SMR:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="fu">aes</span>(<span class="at">fill =</span> deaths)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"COVID-19 deaths"</span>) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"A"</span>) <span class="sc">|</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="fu">aes</span>(<span class="at">fill =</span> expectd)) <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Expected number of deaths"</span>) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"D"</span>) <span class="sc">|</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="fu">aes</span>(<span class="at">fill =</span> deaths <span class="sc">/</span> expectd)) <span class="sc">+</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Standardised mortality ratio"</span>) <span class="sc">+</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"B"</span>, <span class="at">name =</span> <span class="st">"SMR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="1056"></p>
</figure>
</div>
</div>
</div>
<p>And the covariates, including total ICU beds, NO<span class="math inline">\(_2\)</span> and IMD:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="fu">aes</span>(<span class="at">fill =</span> TtlICUB)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Total ICU beds"</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"A"</span>) <span class="sc">|</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="fu">aes</span>(<span class="at">fill =</span> NO2)) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"NO2"</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"D"</span>) <span class="sc">|</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="fu">aes</span>(<span class="at">fill =</span> IMD)) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"IMD"</span>) <span class="sc">+</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"B"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="1056"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-model-with-an-unstructed-spatial-component" class="level2">
<h2 class="anchored" data-anchor-id="a-model-with-an-unstructed-spatial-component">A model with an unstructed spatial component</h2>
<p>The relative risks (RRs) will be smoothed using the Poisson model with a log-link function, as we have seen in previous lectures and labs. As usual in this workshop, the inference is done with <code>NIMBLE</code> called through <code>R</code>.</p>
<p>In particular, let each area <span class="math inline">\(i\)</span> be indexed by the integers <span class="math inline">\(1, 2,...,N\)</span>. The model is as follows:</p>
<p><span class="math display">\[
\begin{eqnarray}
O_{i}  &amp; \sim &amp; \text{Pois}(\lambda_{i}E_{i} ) \quad i = 1, 2,...,N \\
\log(\lambda_{i}) &amp; = &amp; \alpha + \theta_{i}  \\
\theta_{i} &amp; \sim &amp; N(0,\sigma_{\theta})
\end{eqnarray}
\]</span></p>
<p>where <span class="math inline">\(\sigma_{\theta}\)</span> is a standard deviation term that controls the magnitude of <span class="math inline">\(\theta_{i}\)</span>.</p>
<p>As in previous labs, we will write the model in <code>NIMBLE.</code> Specify the prior of <span class="math inline">\(\tau_{\theta}\)</span> in the code below (<code>tau.theta</code>). We can try a Gamma with parameters 1 and 0.01, which is a sensible option for a Poisson count model as it goes from 0 upwards, so can not be negative, like counts:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>UnstrCode <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># priors</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">100000</span>) <span class="co"># vague prior (large variance)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  tau.theta <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="dv">1</span>, <span class="fl">0.01</span>) <span class="co"># prior for the precision hyperparameter</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    O[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i]) <span class="co"># Poisson likelihood</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(mu[i]) <span class="ot">&lt;-</span> <span class="fu">log</span>(E[i]) <span class="sc">+</span> alpha <span class="sc">+</span> theta[i]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">tau =</span> tau.theta) <span class="co"># area-specific RE</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    RR[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha <span class="sc">+</span> theta[i]) <span class="co"># area-specific RR</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># overall RR across study region</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  overallRR <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following code subsets the data to London so the models are quicker to run. The rest of the practical uses England as a whole:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data_england_simpler <span class="ot">&lt;-</span> data_england[<span class="fu">startsWith</span>(data_england<span class="sc">$</span>LTLA, <span class="st">"E09"</span>),]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="at">fill =</span> <span class="st">"NA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How many spatial units in the map?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>n.LTLA <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_england_simpler)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>n.LTLA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 316</code></pre>
</div>
</div>
<p>Create data object as required for <code>NIMBLE</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the number of LTLAs</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>n.LTLA <span class="ot">&lt;-</span> <span class="fu">dim</span>(data_england_simpler)[<span class="dv">1</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the data for NIMBLE in a list</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>COVIDdata <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">O =</span> data_england_simpler<span class="sc">$</span>deaths <span class="co"># observed nb of deaths</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>COVIDConsts <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> n.LTLA, <span class="co"># number of LTLAs</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> data_england_simpler<span class="sc">$</span>expectd <span class="co"># expected number of deaths</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What are the parameters to be initialised? Create a list with two elements and call it <code>inits</code> (each a list) with different initial values for the parameters:</p>
<div class="cell" data-layout-align="center">

</div>
<p>Set <code>parameters_to_monitor</code> a vector to monitor <code>alpha</code>, <code>theta</code>, <code>tau.theta</code>, <code>overallRR</code>, <code>resRR</code>, <code>e</code> and <code>mu</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>parameters_to_monitor <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"theta"</span>, <span class="st">"tau.theta"</span>, <span class="st">"overallRR"</span>, <span class="st">"RR"</span>, <span class="st">"mu"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the parameters that are not set, will NOT be monitored!</p>
<p>Specify the MCMC setting, including number of samples, thining interval, burn-in period, and number of chains.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ni <span class="ot">&lt;-</span> <span class="dv">50000</span> <span class="co"># nb iterations</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>nt <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># thinning interval</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">30000</span> <span class="co"># nb iterations as burn-in</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># nb chains</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The burn-in should be long enough to discard the initial part of the Markov chains that have not yet converged to the stationary distribution.</p>
<p>Run the MCMC simulations calling Nimble from R using the function <code>nimbleMCMC()</code></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>modelGS.sim <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> UnstrCode,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> COVIDdata,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> COVIDConsts,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> parameters_to_monitor,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> ni,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nb,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nt,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nc,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">setSeed =</span> <span class="dv">9</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">progressBar =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>toc <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>toc <span class="sc">-</span> tic <span class="co"># ~ 2minutes</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(modelGS.sim, <span class="at">file =</span> <span class="st">"NIMBLE_IDD_A1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">

</div>
<p>Note that specifying <code>samplesAsCodaMCMC = FALSE</code>, the function <code>nimbleMCMC()</code> returns a list object (if <code>codaPkg = TRUE</code>, file names of <code>NIMBLE</code> output are returned for easy access by the coda package).</p>
<p>What is the summary of each estimated parameter?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_draws</span>(modelGS.sim<span class="sc">$</span>samples, <span class="fu">default_summary_measures</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 951 × 7
   variable  mean median     sd    mad    q5   q95
   &lt;chr&gt;    &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt; &lt;num&gt; &lt;num&gt;
 1 RR[1]    1.37   1.37  0.130  0.131  1.17   1.59
 2 RR[2]    1.96   1.96  0.137  0.137  1.72   2.17
 3 RR[3]    1.02   1.01  0.0970 0.0889 0.875  1.17
 4 RR[4]    0.981  0.980 0.0796 0.0764 0.852  1.11
 5 RR[5]    0.926  0.919 0.0951 0.0912 0.781  1.10
 6 RR[6]    1.36   1.36  0.122  0.118  1.15   1.58
 7 RR[7]    1.36   1.36  0.0834 0.0829 1.23   1.50
 8 RR[8]    0.937  0.936 0.0906 0.0914 0.787  1.08
 9 RR[9]    1.13   1.12  0.0887 0.0898 0.993  1.29
10 RR[10]   1.25   1.25  0.0856 0.0783 1.12   1.41
# ℹ 941 more rows</code></pre>
</div>
</div>
<p>And how good do convergence indicators look?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_draws</span>(modelGS.sim<span class="sc">$</span>samples, <span class="fu">default_convergence_measures</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 951 × 4
   variable  rhat ess_bulk ess_tail
   &lt;chr&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;
 1 RR[1]    1.01      331.     292.
 2 RR[2]    0.998     340.     447.
 3 RR[3]    0.998     435.     335.
 4 RR[4]    0.997     454.     408.
 5 RR[5]    1.00      435.     334.
 6 RR[6]    0.998     396.     365.
 7 RR[7]    1.01      339.     404.
 8 RR[8]    1.00      399.     407.
 9 RR[9]    1.01      369.     403.
10 RR[10]   1.00      415.     324.
# ℹ 941 more rows</code></pre>
</div>
</div>
<p><em>The Gelman-Rubin diagnostic (Rhat)</em></p>
<p>The Gelman-Rubin diagnostic evaluates MCMC convergence by analyzing the difference between multiple Markov chains. The convergence is assessed by comparing the estimated between-chains and within-chain variances for each model parameter. Large differences between these variances indicate nonconvergence.</p>
<p>When the scale reduction factor is high (perhaps greater than 1.1), then we should run our chains out longer to improve convergence to the stationary distribution.</p>
<p>You can use the function <code>rhat()</code> in the package <code>posterior</code> to calculate the <em>Rhat</em> and combine it with the function <code>mcmc_rhat()</code> in the <code>bayesplot</code> package to get a graphical illustration of the <em>Rhats</em>. First you need to create a list of different matrices per parameter. The different columns of these matrices are the different chains:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the parameters you want to estimate rhat for</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>params.rhat <span class="ot">&lt;-</span> modelGS.sim<span class="sc">$</span>samples<span class="sc">$</span>chain1 <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>params.rhat <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "RR[1]" "RR[2]" "RR[3]" "RR[4]" "RR[5]" "RR[6]"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the list of matrices containing the different chains</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(params.rhat, <span class="cf">function</span>(Y) <span class="fu">do.call</span>(cbind, modelGS.sim<span class="sc">$</span>samples[,Y])) <span class="ot">-&gt;</span> list.mat</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>list.mat[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       chain1   chain2
[1,] 1.490680 1.501248
[2,] 1.240415 1.350741
[3,] 1.327398 1.329759
[4,] 1.211267 1.340609
[5,] 1.168241 1.305474
[6,] 1.460581 1.229340</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate rhat</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(list.mat, posterior<span class="sc">::</span>rhat) <span class="ot">-&gt;</span> rhat_values</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>rhat_values <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.0092576 0.9984904 0.9983839 0.9969687 1.0023871 0.9975977</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the rhat</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_rhat</span>(rhat_values) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <em>Rhat</em> of the overallRR is always lower than 1.1.</p>
<p>With more complicated models, sometimes it’s nice to see if the traceplots are working too. Remember there are two chains of samples this time, which should look like they broadly have the same distribution if they have converged.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(modelGS.sim<span class="sc">$</span>samples, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"tau.theta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Use the functions <code>mcmc_acf_bar()</code> and <code>mcmc_acf()</code> to get the autocorrelation plots for the different chains for <code>tau.theta</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_acf_bar</span>(modelGS.sim<span class="sc">$</span>samples, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"tau.theta"</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_acf</span>(modelGS.sim<span class="sc">$</span>samples, <span class="at">regex_pars =</span> <span class="fu">c</span>(<span class="st">"tau.theta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the functions <code>mcmc_acf_bar()</code> and <code>mcmc_acf()</code> to get the autocorrelation plots for the different chains for <code>tau.theta</code> (which should be as near to <code>0</code> as possible).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_acf_bar</span>(modelGS.sim<span class="sc">$</span>samples, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"tau.theta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_acf</span>(modelGS.sim<span class="sc">$</span>samples, <span class="at">regex_pars =</span> <span class="fu">c</span>(<span class="st">"tau.theta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-20-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To see the WAIC, which can be used to compare to other models to evaluate how well parameterised a model was.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>modelGS.sim<span class="sc">$</span>WAIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nimbleList object of type waicNimbleList
Field "WAIC":
[1] 2650.542
Field "lppd":
[1] -1158.889
Field "pWAIC":
[1] 166.3826</code></pre>
</div>
</div>
</section>
<section id="map-of-the-globally-smoothed-rrs" class="level2">
<h2 class="anchored" data-anchor-id="map-of-the-globally-smoothed-rrs">Map of the (globally) smoothed RRs</h2>
<p>Let’s map the smoothed RRs in R we extract the posterior median of the relative risks</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>RR <span class="ot">&lt;-</span> modelGS.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"RR["</span>, <span class="dv">1</span><span class="sc">:</span>n.LTLA, <span class="st">"]"</span>), <span class="st">"Median"</span>] <span class="co"># posterior median</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Add it on the shapefile</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>data_england_simpler<span class="sc">$</span>RR <span class="ot">&lt;-</span> RR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code>ggplot2</code>, we can produce a map of the smoothed RRs</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="at">data =</span> data_england_simpler, <span class="fu">aes</span>(<span class="at">fill =</span> RR)) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">scale_fill_viridis_c</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">name =</span> <span class="st">"SMR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-bym-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-bym-model">The BYM model</h2>
<p>The RRs will be smoothed using the Poisson model and the BYM model in the log-link function. The inference is done with <code>NIMBLE</code> called through R. In particular, let each area <span class="math inline">\(i\)</span> be indexed by the integers <span class="math inline">\(1, 2,...,N\)</span>. The model is as follows.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>DESCRIPTION OF BYM</p>
</div></div><p><span class="math display">\[
\begin{equation}
\begin{aligned}
\hbox{O}_i &amp; \sim \hbox{Poisson}(E_i \lambda_i); \;\;\; i=1,...,N\\
\log \lambda_i &amp; = \alpha + \theta_i + \phi_i\\
\theta_i &amp;\sim \hbox{Normal}(0, \sigma^2_{\theta_i})\\
{\bf \phi} &amp; \sim \hbox{ICAR}({\bf W}, \sigma_{\phi}^2) \,\, ,  \sum_i \phi_i  = 0 \\
\alpha &amp; \sim \text{Uniform}(-\infty, +\infty) \\
1/\sigma_{\theta}^2 &amp; \sim \hbox{Gamma}(0.5, 0.05) \\
1/\sigma_{\phi}^2 &amp; \sim \hbox{Gamma}(0.5, 0.0005) \\
\end{aligned}
\end{equation}
\]</span></p>
<p>where <span class="math inline">\(\sigma_{\phi}\)</span> is a standard deviation term that controls the magnitude of <span class="math inline">\(\phi_{i}\)</span>, i.e.&nbsp;the spatial structured term.</p>
<p>Run the MCMC simulations calling <code>NIMBLE</code> from R using the function <code>nimbleMCMC()</code></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>BYMCode <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># priors</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dflat</span>() <span class="co"># vague prior (Unif(-inf, +inf))</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  overallRR <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha) <span class="co"># overall RR across study region</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  tau.theta <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.5</span>, <span class="fl">0.05</span>) <span class="co"># prior for the precision hyperparameter</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  sigma2.theta <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> tau.theta <span class="co"># variance of unstructured area random effects</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  tau.phi <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.5</span>, <span class="fl">0.0005</span>) <span class="co"># prior on precision of spatial area random effects</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  sigma2.phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> tau.phi <span class="co"># conditional variance of spatial area random effects</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># likelihood</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    O[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i]) <span class="co"># Poisson likelihood for observed counts</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(mu[i]) <span class="ot">&lt;-</span> <span class="fu">log</span>(E[i]) <span class="sc">+</span> alpha <span class="sc">+</span> theta[i] <span class="sc">+</span> phi[i]</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">tau =</span> tau.theta) <span class="co"># area-specific RE</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    SMR[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha <span class="sc">+</span> theta[i] <span class="sc">+</span> phi[i])</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    resRR[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(theta[i] <span class="sc">+</span> phi[i]) <span class="co"># area-specific residual RR</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    proba.resRR[i] <span class="ot">&lt;-</span> <span class="fu">step</span>(resRR[i] <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># Posterior probability</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># BYM</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  phi[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dcar_normal</span>(<span class="at">adj =</span> adj[<span class="dv">1</span><span class="sc">:</span>L], <span class="at">weights =</span> weights[<span class="dv">1</span><span class="sc">:</span>L], <span class="at">num =</span> num[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">tau =</span> tau.phi, <span class="at">zero_mean =</span> <span class="dv">1</span>)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-the-adjacency-matrix" class="level1">
<h1>Creating the adjacency matrix</h1>
<p>To fit a BYM model, we first need to define an adjacency matrix, which describes which spatial units are actually neighbouring each other. The equation is below, but essentially if the units neighbour, they are given <code>1</code> in the relevant adjacency matrix, otherwise the element representing whether two spatial units are neighbouring (sometimes called ‘contiguous’) then it is given a value of <code>0</code>. Most of the elements in a matrix will be <code>0</code> for a real-world situation with lots of spatial units.</p>
<p>To run the BYM model, the adjacency matrix needs to be provided. Recall that there are many ways of defining an adjacency matrix <span class="math inline">\({\bf W}\)</span>. Here we will use queen contiguity which is defined as <span class="math display">\[
\begin{equation}
w_{ij} =
\begin{cases}
1 &amp; \text{if } j \in \partial_i  \\
0         &amp; \text{otherwise}
\end{cases}
\end{equation}
\]</span></p>
<p>where <span class="math inline">\(\partial_i\)</span> is the set of area adjacent to <span class="math inline">\(i\)</span>, and <span class="math inline">\(w_{ij}\)</span> is the <span class="math inline">\(ij\)</span> element of <span class="math inline">\({\bf W}\)</span>.</p>
</section>
<section id="adjacency-matrix-in-r" class="level1">
<h1>Adjacency matrix in R</h1>
<p>Convert the polygons to a list of neighbors using the function <code>poly2nb()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>LTLA_nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(<span class="at">pl =</span> data_england_simpler)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>LTLA_nb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 316 
Number of nonzero links: 1332 
Percentage nonzero weights: 1.333921 
Average number of links: 4.21519 
3 regions with no links:
44 95 284</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract centroids from the England shp</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>centr <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(data_england_simpler) <span class="sc">%&gt;%</span> <span class="fu">st_geometry</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see from the plot below, the matrix will represent the network of connections as represented by the black graph below</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_england_simpler<span class="sc">$</span>geometry, <span class="at">border =</span> <span class="st">"grey66"</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LTLA_nb, centr, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">add =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Convert the list you defined previously to NIMLE format (i.e.&nbsp;a list of 3 components adj, num and weights) using the function <code>nb2WB()</code> and print a summary of the object.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>nbWB_A <span class="ot">&lt;-</span> <span class="fu">nb2WB</span>(<span class="at">nb =</span> LTLA_nb)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(nbWB_A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "adj"     "weights" "num"    </code></pre>
</div>
</div>
<p>A list of three components is created</p>
<ol type="1">
<li><code>adj</code> = <code>ID</code> for all the neighbors;</li>
<li><code>weights</code> = the weight for each neighbour; and</li>
<li>num = total nb of neighbors across the study region</li>
</ol>
<p>Create data and constants objects as required for <code>NIMBLE</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>n.LTLA <span class="ot">&lt;-</span> <span class="fu">dim</span>(data_england_simpler)[<span class="dv">1</span>]</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the data for NIMBLE in a list</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>COVIDdata <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">O =</span> data_england_simpler<span class="sc">$</span>deaths <span class="co"># observed nb of deaths</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>COVIDConsts <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> n.LTLA, <span class="co"># nb of LTLAs</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># adjacency matrix</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">L =</span> <span class="fu">length</span>(nbWB_A<span class="sc">$</span>weights), <span class="co"># the number of neighboring areas</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> data_england_simpler<span class="sc">$</span>expectd, <span class="co"># expected number of deaths</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">adj =</span> nbWB_A<span class="sc">$</span>adj, <span class="co"># the elements of the neighbouring matrix</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">num =</span> nbWB_A<span class="sc">$</span>num,</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> nbWB_A<span class="sc">$</span>weights</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the initial values for ALL the unknown parameters:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initialise the unknown parameters, 2 chains</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.01</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.theta =</span> <span class="dv">10</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.phi =</span> <span class="dv">1</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> <span class="fu">rep</span>(<span class="fl">0.01</span>, <span class="at">times =</span> n.LTLA),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">0.5</span>, <span class="at">times =</span> n.LTLA))</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.theta =</span> <span class="dv">1</span>,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.phi =</span> <span class="fl">0.1</span>,</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> <span class="fu">rep</span>(<span class="fl">0.05</span>, <span class="at">times =</span> n.LTLA),</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="at">times =</span> n.LTLA))</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which model parameters do you want to monitor? Set these before running <code>NIMBLE</code> Call this object <code>parameters_to_monitor</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>parameters_to_monitor <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sigma2.theta"</span>, <span class="st">"sigma2.phi"</span>, <span class="st">"overallRR"</span>, <span class="st">"theta"</span>, <span class="st">"SMR"</span>, <span class="st">"resRR"</span>, <span class="st">"proba.resRR"</span>, <span class="st">"alpha"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Specify the MCMC setting, as we always do</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ni <span class="ot">&lt;-</span> <span class="dv">50000</span> <span class="co"># nb iterations</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>nt <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># thinning interval</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">10000</span> <span class="co"># nb iterations as burning</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># nb chains</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s run the model, this needs approximately 2 minutes.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>modelBYM.sim <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> BYMCode,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> COVIDdata,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> COVIDConsts,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> parameters_to_monitor,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> ni,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nb,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nt,</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nc,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">setSeed =</span> <span class="dv">9</span>,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">progressBar =</span> <span class="cn">FALSE</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>toc <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>toc <span class="sc">-</span> tic</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(modelBYM.sim, <span class="at">file =</span> <span class="st">"NIMBLE_BYM_A3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>modelBYM.sim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"NIMBLE_BYM_A3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Retrieve WAIC and compare with previous model. Which model performs best?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>modelBYM.sim<span class="sc">$</span>WAIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nimbleList object of type waicNimbleList
Field "WAIC":
[1] 2633.322
Field "lppd":
[1] -1158.332
Field "pWAIC":
[1] 158.3288</code></pre>
</div>
</div>
<p>Check convergence of resRR</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(modelBYM.sim<span class="sc">$</span>samples, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"resRR[1]"</span>, <span class="st">"resRR[5]"</span>, <span class="st">"resRR[15]"</span>, <span class="st">"resRR[19]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol type="a">
<li>Extract the residual RR (i.e.&nbsp;exp(V + U)) and the posterior probability that resRR is higher than 1 as. Create a <code>data.frame</code> for this purpose. Note that for the posterior probability, which is a vector of 0s and 1s we need to calculate the sum of 1s by the total sum, ie the mean.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>RR_BYM <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">RR_BYM =</span> modelBYM.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"resRR["</span>, <span class="dv">1</span><span class="sc">:</span>n.LTLA, <span class="st">"]"</span>), <span class="st">"Median"</span>],</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pp_BYM =</span> modelBYM.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"proba.resRR["</span>, <span class="dv">1</span><span class="sc">:</span>n.LTLA, <span class="st">"]"</span>), <span class="st">"Mean"</span>]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="a">
<li>Add a column ID for each LTLA, from 1 to 316, to <em>RR_BYM</em>.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>RR_BYM<span class="sc">$</span>LTLA <span class="ot">&lt;-</span> data_england_simpler<span class="sc">$</span>LTLA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="a">
<li>Change the name of the column corresponding to the posterior mean to BYM</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(RR_BYM) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BYM"</span>, <span class="st">"pp_resRR"</span>, <span class="st">"LTLA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="a">
<li>Merge RR_BYM with COVID19Deaths using LTLA as column for merging. Call the new object <em>COVID19Deaths</em>.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>COVID19Deaths <span class="ot">&lt;-</span> <span class="fu">left_join</span>(data_england_simpler, RR_BYM, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"LTLA"</span> <span class="ot">=</span> <span class="st">"LTLA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="a">
<li>Map the smoothed residual RR (resRR). You can use the <code>ggplot</code> function for this purpose:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> COVID19Deaths, <span class="fu">aes</span>(<span class="at">fill =</span> BYM)) <span class="sc">+</span> <span class="co"># standard map</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"RR"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Posterior median RR"</span>) <span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="co"># removes xaxis title</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>() <span class="co"># removes yaxis title</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> COVID19Deaths, <span class="fu">aes</span>(<span class="at">fill =</span> pp_resRR)) <span class="sc">+</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Prob"</span>) <span class="sc">+</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Exceedance probability"</span>) <span class="sc">+</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="co"># removes xaxis title</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>() <span class="co"># removes yaxis title</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<section id="closing-remarks" class="level2">
<h2 class="anchored" data-anchor-id="closing-remarks">Closing remarks</h2>
<p>In this lab session, we have explored how to fit spatial models using Bayesian regression in <code>NIMBLE</code>. We looked at the two most common approaches: iid and the BYM model.</p>
<p>We used real data on COVID-19 deaths in England during March-July 2020 and first performed disease mapping to understand the spatial trends of COVID-19 mortality in the first stages of the pandemic. As part of this analysis, we visualised spatial data, fitted a model with an unstructured spatial random effect, demonstrated how to build a neihgborhood matrix in R and fitted the BYM model.</p>
<p>For more information on the final model see Konstantinoudis et al 2021 (10.1016/j.envint.2020.106316).</p>
</section>
<section id="advanced-ecological-regression-with-the-bym-model" class="level2">
<h2 class="anchored" data-anchor-id="advanced-ecological-regression-with-the-bym-model">Advanced: Ecological regression with the BYM model</h2>
<p>The section below is very relevant for environmental health, but if we run out of time in the lab, it is something you should go through in your own time.</p>
<p>Let <span class="math inline">\(\mathcal{D}\)</span> be the observation window of England and <span class="math inline">\(A_1, A_2, \dots, A_N\)</span> a partition denoting the LTLAs in England with <span class="math inline">\(\cup_{i=1}^NA_i = \mathcal{D}\)</span> and <span class="math inline">\(A_i\cap A_j\)</span> for every <span class="math inline">\(i\neq j\)</span>. Let <span class="math inline">\(O_1, O_2, \dots, O_N\)</span> be the observed number of COVID-19 deaths occurred during March-July 2020 in England, <span class="math inline">\(E_1, E_2, \dots, E_N\)</span> is the expected number of COVID-19 deaths and <span class="math inline">\(\lambda_1, \lambda_2, \dots, \lambda_N\)</span> the standardized mortality ratio (recall <span class="math inline">\(\lambda_i = \frac{O_i}{E_i}\)</span>). A standardized mortality ratio of <span class="math inline">\(1.5\)</span> implies that the COVID-19 deaths we observed in the <span class="math inline">\(i\)</span>-th area are <span class="math inline">\(1.5\)</span> times higher to what we expected. Under the Poisson assumption we have: <span class="math display">\[
\begin{equation}
\begin{aligned}
\hbox{O}_i &amp; \sim \hbox{Poisson}(E_i \lambda_i); \;\;\; i=1,...,N\\
\log \lambda_i &amp; = \alpha +  \beta_1 X_{1i} + \beta_2 X_{2i} + \theta_i + \phi_i\\
\theta_i &amp;\sim \hbox{Normal}(0, \sigma^2_{\theta_i})\\
{\bf \phi} &amp; \sim \hbox{ICAR}({\bf W}, \sigma_{\phi}^2) \,\, ,  \sum_i \phi_i  = 0 \\
\alpha &amp; \sim \text{Uniform}(-\infty, +\infty) \\
\beta_1, \beta_2 &amp; \sim \mathcal{N}(0, 10) \\
1/\sigma_{\theta}^2 &amp; \sim \hbox{Gamma}(0.5, 0.05) \\
1/\sigma_{\phi}^2 &amp; \sim \hbox{Gamma}(0.5, 0.0005) \\
\end{aligned}
\end{equation}
\]</span></p>
<p>the terms <span class="math inline">\(\beta_1 X_{1i} + \beta_2 X_{2i} + \sum_{j=2}^5\beta_{3j} X_{3i}\)</span>, where <span class="math inline">\(X_{1i}, X_{2i}, X_{3i}\)</span> are the ICU beds, NO<span class="math inline">\(_2\)</span> and IMD in the <span class="math inline">\(i\)</span>-th LTLA, <span class="math inline">\(\beta_1, \beta_2, \sum_{j=2}^5\beta_{3j}\)</span> the corresponding effects and <span class="math inline">\(exp(\beta_1), exp(\beta_2)\)</span> the relative risk of ICU beds or NO<span class="math inline">\(_2\)</span> for every unit increase and of the ICU beds or NO<span class="math inline">\(_2\)</span>. For instance <span class="math inline">\(exp(\beta_2) = 1.8\)</span> means that for every unit increase of long term exposure to <span class="math inline">\(NO_2\)</span>, the risk (read standardized mortality ratio) of COVID-19 deaths cancer increases by <span class="math inline">\(80\%\)</span>. <span class="math inline">\(exp(\beta_{32}), \beta_{33}, \beta_{34}, \beta_{35}\)</span> are the relative risks compared to the baseline IMD category, ie the most deprived areas. An <span class="math inline">\(exp(\beta_{35}) = 0.5\)</span> means that the risk of COVID-19 deaths in most affluent areas decreases by <span class="math inline">\(50%\)</span> compared to the most deprived areas.<span class="math inline">\(\tau_{\theta}\)</span> is a precision (reciprocal of the variance) term that controls the magnitude of <span class="math inline">\(\theta_{i}\)</span>. We will first write the model in <code>NIMBLE</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>BYMecoCode <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    O[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i]) <span class="co"># Poisson likelihood for observed counts</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(mu[i]) <span class="ot">&lt;-</span> <span class="fu">log</span>(E[i]) <span class="sc">+</span> alpha <span class="sc">+</span> theta[i] <span class="sc">+</span> phi[i] <span class="sc">+</span> <span class="fu">inprod</span>(beta[], X[i,])</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the inprod is equivalent with beta[1]*X1[i] + beta[2]*X2[i] + beta[3]*X32[i] + beta[4]*X33[i] + beta[5]*X34[i] + beta[6]*X35[i]</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    SMR[i] <span class="ot">&lt;-</span> alpha <span class="sc">+</span> theta[i] <span class="sc">+</span> phi[i] <span class="sc">+</span> <span class="fu">inprod</span>(beta[], X[i,])</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">tau =</span> tau.theta) <span class="co"># area-specific RE</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    resRR[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(theta[i] <span class="sc">+</span> phi[i]) <span class="co"># area-specific residual RR</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    proba.resRR[i] <span class="ot">&lt;-</span> <span class="fu">step</span>(resRR[i] <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># Posterior probability</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># BYM prior</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  phi[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dcar_normal</span>(<span class="at">adj =</span> adj[<span class="dv">1</span><span class="sc">:</span>L], <span class="at">weights =</span> weights[<span class="dv">1</span><span class="sc">:</span>L], <span class="at">num =</span> num[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">tau =</span> tau.phi, <span class="at">zero_mean =</span> <span class="dv">1</span>)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dflat</span>() <span class="co"># vague prior (Unif(-inf, +inf))</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  overallRR <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha) <span class="co"># overall RR across study region</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  tau.theta <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.5</span>, <span class="fl">0.05</span>) <span class="co"># prior for the precision hyperparameter</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  sigma2.theta <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> tau.theta <span class="co"># variance of unstructured area random effects</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  tau.phi <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.5</span>, <span class="fl">0.0005</span>) <span class="co"># prior on precison of spatial area random effects</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  sigma2.phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> tau.phi <span class="co"># conditional variance of spatial area random effects</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># priors for the fixed effects</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>        beta[j] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">tau =</span> <span class="dv">1</span>)</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>      RR.beta[j] <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta[j])</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>  RR.beta1_1NO2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta[<span class="dv">1</span>]<span class="sc">/</span>sd.no2) <span class="co"># get per 1 unit increase in the airpollution (scale back)</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create data object as required for <code>NIMBLE</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>n.LTLA <span class="ot">&lt;-</span> <span class="fu">dim</span>(data_england_simpler)[<span class="dv">1</span>]</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create the dummies for deprivation:</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>fastDummies<span class="sc">::</span><span class="fu">dummy_cols</span>(data_england_simpler<span class="sc">$</span>IMD) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.data_1<span class="sc">:</span>.data_5) <span class="sc">%&gt;%</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">IMD_1 =</span> .data_1, <span class="at">IMD_2 =</span> .data_2, <span class="at">IMD_3 =</span> .data_3, </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">IMD_4 =</span> .data_4, <span class="at">IMD_5 =</span> .data_5) <span class="ot">-&gt;</span> dummies</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>data_england_simpler <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data_england_simpler, dummies)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Matrix of covariates</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">scale</span>(data_england_simpler<span class="sc">$</span>NO2)[, <span class="dv">1</span>],</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale</span>(data_england_simpler<span class="sc">$</span>TtlICUB)[, <span class="dv">1</span>], </span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>            data_england_simpler<span class="sc">$</span>IMD_2, </span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>            data_england_simpler<span class="sc">$</span>IMD_3, </span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>            data_england_simpler<span class="sc">$</span>IMD_4,</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>            data_england_simpler<span class="sc">$</span>IMD_5)</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="co"># number of total covariates</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>K <span class="ot">=</span> <span class="fu">ncol</span>(Xmat)</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the data for NIMBLE in a list</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>COVIDdata <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">O =</span> data_england_simpler<span class="sc">$</span>deaths, <span class="co"># observed nb of deaths</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># covariates</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> Xmat</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>COVIDConsts <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> n.LTLA, <span class="co"># nb of LTLAs</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">K =</span> K,</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># adjacency matrix</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">L =</span> <span class="fu">length</span>(nbWB_A<span class="sc">$</span>weights), <span class="co"># the number of neighboring areas</span></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> data_england_simpler<span class="sc">$</span>expectd, <span class="co"># expected number of deaths</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">adj =</span> nbWB_A<span class="sc">$</span>adj, <span class="co"># the elements of the neighboring matrix</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">num =</span> nbWB_A<span class="sc">$</span>num,</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> nbWB_A<span class="sc">$</span>weights, </span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd.no2 =</span> data_england_simpler<span class="sc">$</span>NO2 <span class="sc">%&gt;%</span> <span class="fu">sd</span>()</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create the initial values for ALL the unknown parameters:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initialise the unknown parameters, 2 chains</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.01</span>,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">rep</span>(<span class="dv">0</span>, K),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.theta =</span> <span class="dv">10</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.phi =</span> <span class="dv">1</span>,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> <span class="fu">rep</span>(<span class="fl">0.01</span>, <span class="at">times =</span> n.LTLA),</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">0.5</span>, <span class="at">times =</span> n.LTLA))</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, K),</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.theta =</span> <span class="dv">1</span>,</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau.phi =</span> <span class="fl">0.1</span>,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> <span class="fu">rep</span>(<span class="fl">0.05</span>, <span class="at">times =</span> n.LTLA),</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="at">times =</span> n.LTLA))</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which model parameters do you want to monitor? Set these before running <code>NIMBLE</code> Call this object <code>parameters_to_monitor</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>parameters_to_monitor <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sigma2.theta"</span>, <span class="st">"sigma2.phi"</span>, <span class="st">"overallRR"</span>, <span class="st">"theta"</span>, <span class="st">"beta"</span>, <span class="st">"RR.beta"</span>, <span class="st">"resRR"</span>, <span class="st">"proba.resRR"</span>, <span class="st">"alpha"</span>, <span class="st">"RR.beta1_1NO2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Specify the MCMC setting</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>ni <span class="ot">&lt;-</span> <span class="dv">50000</span> <span class="co"># nb iterations</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>nt <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># thinning interval</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">10000</span> <span class="co"># nb iterations as burning</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># nb chains</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Run the MCMC simulations calling <code>NIMBLE</code> from R using the function <code>nimbleMCMC()</code>. If everything is specified reasonably, this needs approximately 5 minutes.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>modelBYMeco.sim <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> BYMecoCode,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> COVIDdata,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> COVIDConsts,</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> parameters_to_monitor,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> ni,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nb,</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nt,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nc,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">setSeed =</span> <span class="dv">9</span>,</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">progressBar =</span> <span class="cn">FALSE</span>,</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>toc <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>toc <span class="sc">-</span> tic</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(modelBYMeco.sim, <span class="at">file =</span> <span class="st">"NIMBLE_BYM_A4"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>modelBYMeco.sim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"NIMBLE_BYM_A4"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Retrieve WAIC and compare with previous model. Which model performs best?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>modelBYMeco.sim<span class="sc">$</span>WAIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nimbleList object of type waicNimbleList
Field "WAIC":
[1] 2630.603
Field "lppd":
[1] -1158.595
Field "pWAIC":
[1] 156.7069</code></pre>
</div>
</div>
<p>Check the convergence of the intercept and the different covariates. What do you observe?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(modelBYMeco.sim<span class="sc">$</span>samples, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="fu">paste0</span>(<span class="st">"beta["</span>, <span class="dv">1</span><span class="sc">:</span>K, <span class="st">"]"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Retrieve summary statistics for the different covariates covariates and interpret (it is easier to interpret on the relative scale):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>modelBYMeco.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"RR.beta["</span>, <span class="dv">1</span><span class="sc">:</span>K, <span class="st">"]"</span>), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Mean    Median    St.Dev. 95%CI_low 95%CI_upp
RR.beta[1] 1.2519365 1.2524190 0.04673867 1.1597589 1.3395889
RR.beta[2] 0.9645565 0.9640884 0.01590041 0.9337215 0.9961903
RR.beta[3] 0.9385009 0.9363240 0.05052736 0.8436705 1.0426100
RR.beta[4] 0.9018306 0.9015376 0.04897722 0.8085916 1.0006981
RR.beta[5] 0.9494108 0.9496892 0.05695198 0.8366907 1.0598967
RR.beta[6] 0.9140398 0.9142683 0.05849248 0.7988786 1.0307437</code></pre>
</div>
</div>
<p>We can get a nice credible intervals plot as well:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>modelBYMeco.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"RR.beta["</span>, <span class="dv">1</span><span class="sc">:</span>K, <span class="st">"]"</span>), ] <span class="sc">%&gt;%</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Median, <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">covariate =</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"NO2"</span>, <span class="st">"ICU"</span>, <span class="fu">paste0</span>(<span class="st">"IMD"</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)), </span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"NO2"</span>, <span class="st">"ICU"</span>, <span class="fu">paste0</span>(<span class="st">"IMD"</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)))) <span class="ot">-&gt;</span> cov.eff</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>cov.eff <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  Median `95%CI_low` `95%CI_upp` covariate
   &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    
1  1.25        1.16        1.34  NO2      
2  0.964       0.934       0.996 ICU      
3  0.936       0.844       1.04  IMD2     
4  0.902       0.809       1.00  IMD3     
5  0.950       0.837       1.06  IMD4     
6  0.914       0.799       1.03  IMD5     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>cov.eff <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> covariate, <span class="at">y =</span> Median)) <span class="sc">+</span> </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">x=</span>covariate, <span class="at">ymin =</span> <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span> </span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.5</span>)) <span class="sc">+</span> </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The effect by unit increase in the long term exposure to NO<span class="math inline">\(_2\)</span> is <code>RR.beta1_1NO2</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># as relative risk per 1 unit increase in the long term NO2 exposure</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>modelBYMeco.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"RR.beta1_1NO2"</span>), <span class="fu">c</span>(<span class="st">"Median"</span>, <span class="st">"95%CI_low"</span>, <span class="st">"95%CI_upp"</span>)] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Median 95%CI_low 95%CI_upp 
 1.038588  1.025246  1.050411 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># as percentage increase in mortality for 1 unit increase in the long term NO2 exposure</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>(modelBYMeco.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"RR.beta1_1NO2"</span>), <span class="fu">c</span>(<span class="st">"Median"</span>, <span class="st">"95%CI_low"</span>, <span class="st">"95%CI_upp"</span>)] <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Median 95%CI_low 95%CI_upp 
 3.858833  2.524564  5.041070 </code></pre>
</div>
</div>
<p>For every 1<span class="math inline">\(\mu\)</span>g/<span class="math inline">\(m^3\)</span> increase in the long term exposure to NO<span class="math inline">\(_2\)</span> the COVID-19 mortality increase by 3%.</p>
<p>Compare the BYM-related spatial field before and after adjusting for covariates.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>COVID19Deaths<span class="sc">$</span>BYM_ECO <span class="ot">&lt;-</span> modelBYMeco.sim<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">paste0</span>(<span class="st">"resRR["</span>, <span class="dv">1</span><span class="sc">:</span>n.LTLA, <span class="st">"]"</span>), <span class="st">"Median"</span>]</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> COVID19Deaths, <span class="fu">aes</span>(<span class="at">fill =</span> BYM)) <span class="sc">+</span> <span class="co"># standard map</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"unadj"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">2.2</span>)) <span class="sc">+</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Posterior median RR (unadj)"</span>) <span class="sc">+</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="co"># removes xaxis title</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>() <span class="co"># removes yaxis title</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> COVID19Deaths, <span class="fu">aes</span>(<span class="at">fill =</span> BYM_ECO)) <span class="sc">+</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"adj"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">2.2</span>)) <span class="sc">+</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior median RR (adj)"</span>) <span class="sc">+</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="co"># removes xaxis title</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>() <span class="co"># removes yaxis title</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spatiotemporal_models_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="further-closing-remarks-for-advanced-section" class="level2">
<h2 class="anchored" data-anchor-id="further-closing-remarks-for-advanced-section">Further closing remarks for Advanced section</h2>
<p>If you got through the advanced portion, we examined the effect of long term exposure to NO<span class="math inline">\(_2\)</span> on COVID-19 mortality. We fitted a BYM model to account for unknown spatial confounding but in addition we accounted for total number of ICU beds and deprivation per LTLA. We reported evidence of an increased COVID-19 mortality for increasing levels of NO<span class="math inline">\(_2\)</span>.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>